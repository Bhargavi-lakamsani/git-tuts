pipeline {
    agent none
    triggers {
        cron 'H/5 * * * *' // Trigger every 5 minutes
        pollSCM 'H/5 * * * *' // Poll SCM every 5 minutes
    }

    environment {
        ENV_VAR_STRING = "Bhargavi"
        ENV_VAR_CHOICE = "DEV"
        ENV_VAR_BOOLEAN = true
    }

    stages {
        stage('Agent 1 - Stage 1') {
            agent { label 'agent1' }
            steps {
                script {
                    println "Global variable BUILD_NUMBER: ${env.BUILD_NUMBER}"
                    println "Global variable BUILD_URL: ${env.BUILD_URL}"
                    println "Global variable JOB_NAME: ${env.JOB_NAME}"
                    println "Environment variable ENV_VAR_STRING: ${ENV_VAR_STRING}"
                    println "Environment variable ENV_VAR_CHOICE: ${ENV_VAR_CHOICE}"
                    println "Environment variable ENV_VAR_BOOLEAN: ${ENV_VAR_BOOLEAN}"
                }
            }
        }

        stage('Agent 1 - Stage 2') {
            agent { label 'agent1' }
            steps {
                script {
                    echo "Performing Stage 2 in Agent 1"
                }
            }
            post { 
                success {
                    echo "Stage 2 completed successfully"
                }
            }
        }

        stage('Agent 2 - Stage 3') {
            agent { label 'agent2' }
            when {
                allOf {
                    branch 'master, DEV'
                    expression {
                        return currentBuild.result == 'SUCCESS'
                    }
                }
            }
            environment {
                SECRET_TEXT = credentials('MY_SECRET_TEXT')
                USERNAME = credentialsId('MY_USERNAME')
                PASSWORD = credentialsId('MY_PASSWORD')
            }
            steps {
                echo "Performing Stage 3 in Agent 2"
                echo "Secret Text: $SECRET_TEXT"
                echo "Username: $USERNAME"
                echo "Password: $PASSWORD"
            }
            post { 
                success {
                    echo "Stage 3 completed successfully"
                }
            }
        }

        stage('Agent 2 - Stage 4') {
            agent { label 'agent2' }
            when {
                allOf {
                    expression {
                        return currentBuild.result == 'SUCCESS'
                    }
                    previousStage 'Agent 2 - Stage 3'
                }
            }
            steps {
                echo "Performing Stage 4 in Agent 2"
            }
            post {
                success {
                    echo "Stage 4 completed successfully"
                    emailext body: "Hi,\nStage 4 completed successfully.\nThank you.", 
                             subject: "Pipeline Build Status", 
                             to: "navatabhargavi@email.com"
                }
            }
        }
    }
}
